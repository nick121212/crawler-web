'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _regenerator = require('babel-runtime/regenerator');

var _regenerator2 = _interopRequireDefault(_regenerator);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _asyncToGenerator2 = require('babel-runtime/helpers/asyncToGenerator');

var _asyncToGenerator3 = _interopRequireDefault(_asyncToGenerator2);

var _co = require('co');

var _co2 = _interopRequireDefault(_co);

var _debug = require('debug');

var _debug2 = _interopRequireDefault(_debug);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _boom = require('boom');

var _boom2 = _interopRequireDefault(_boom);

var _fs = require('fs');

var _fs2 = _interopRequireDefault(_fs);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var opts = {
  encoding: 'utf8'
};

// error pages were inspired by HTML5 Boilerplate's default 404.html page
// https://github.com/h5bp/html5-boilerplate/blob/master/src/404.html
var _404 = _fs2.default.readFileSync(_path2.default.join(__dirname, '..', '404.html'), opts);
var _500 = _fs2.default.readFileSync(_path2.default.join(__dirname, '..', '500.html'), opts);

var debug = new _debug2.default('koa-better-error-handler');

// initialize try/catch error handling right away
// adapted from: https://github.com/koajs/onerror/blob/master/index.js
// https://github.com/koajs/examples/issues/20#issuecomment-31568401
//
// inspired by:
// https://goo.gl/62oU7P
// https://goo.gl/8Z7aMe

exports.default = function () {
  var _ref = (0, _asyncToGenerator3.default)(_regenerator2.default.mark(function _callee(err) {
    var type, val, hasFlash, hasSessions, hasRender, noReferrer;
    return _regenerator2.default.wrap(function _callee$(_context) {
      while (1) {
        switch (_context.prev = _context.next) {
          case 0:
            if (err) {
              _context.next = 2;
              break;
            }

            return _context.abrupt('return');

          case 2:

            if (!_lodash2.default.isError(err)) err = new Error(err);

            type = this.accepts(['text', 'json', 'html']);


            if (!type) {
              debug('invalid type, sending 406 error');
              err.status = 406;
              err.message = _boom2.default.notAcceptable().output.payload;
            }

            // parse mongoose validation errors
            err = parseValidationError(this, err);

            // check if we threw just a status code in order to keep it simple
            val = parseInt(err.message, 10);

            if (_lodash2.default.isNumber(val) && val >= 400) err = _boom2.default.create(val);

            // check if we have a boom error that specified
            // a status code already for us (and then use it)
            if (_lodash2.default.isObject(err.output) && _lodash2.default.isNumber(err.output.statusCode)) err.status = err.output.statusCode;

            if (!_lodash2.default.isNumber(err.status)) err.status = 500;

            // check if there is flash messaging
            hasFlash = _lodash2.default.isFunction(this.flash);

            debug('hasFlash', hasFlash);

            // check if there is session support
            hasSessions = _lodash2.default.isObject(this.session) && _lodash2.default.isObject(this.sessionStore) && _lodash2.default.isString(this.sessionId) && _lodash2.default.isObject(this.session) && _lodash2.default.isFunction(this.sessionStore.set);

            debug('hasSessions', hasSessions);

            // check if there is a view rendering engine binding `this.render`
            hasRender = _lodash2.default.isFunction(this.render);

            debug('hasRender', hasRender);

            // check if we're about to go into a possible endless redirect loop
            noReferrer = this.get('Referrer') === '';

            // populate the status and body with `boom` error message payload
            // (e.g. you can do `ctx.throw(404)` and it will output a beautiful err obj)

            this.status = this.statusCode = err.statusCode = err.status = err.status || 500;
            this.body = _boom2.default.create(err.status, err.message).output.payload;

            debug('status code was %d', this.status);

            this.app.emit('error', err, this);

            // nothing we can do here other
            // than delegate to the app-level
            // handler and log.

            if (!(this.headerSent || !this.writable)) {
              _context.next = 25;
              break;
            }

            debug('headers were already sent, returning early');
            err.headerSent = true;
            return _context.abrupt('return');

          case 25:

            // fix page title and description
            this.state.title = this.body.error;
            debug('set `this.state.title` to %s', this.state.title);
            this.state.desc = err.message;
            debug('set `this.state.desc` to %s', this.state.desc);

            debug('type was %s', type);

            _context.t0 = type;
            _context.next = _context.t0 === 'html' ? 33 : _context.t0 === 'json' ? 77 : 80;
            break;

          case 33:

            this.type = 'html';

            if (!(this.status === 404)) {
              _context.next = 51;
              break;
            }

            if (!hasRender) {
              _context.next = 48;
              break;
            }

            _context.prev = 36;

            debug('rendering 404 page');
            _context.next = 40;
            return this.render('404');

          case 40:
            _context.next = 46;
            break;

          case 42:
            _context.prev = 42;
            _context.t1 = _context['catch'](36);

            debug('could not find 404 page, using built-in 404 html');
            this.body = _404;

          case 46:
            _context.next = 49;
            break;

          case 48:
            this.body = _404;

          case 49:
            _context.next = 76;
            break;

          case 51:
            if (!(noReferrer || this.status === 500)) {
              _context.next = 70;
              break;
            }

            // this prevents a redirect loop by detecting an empty Referrer
            // ...otherwise it would reach the next conditional block which
            // would endlessly rediret the user with `this.redirect('back')`
            if (noReferrer) debug('prevented endless redirect loop!');

            // flash an error message
            if (hasFlash) this.flash('error', err.message);

            // render the 500 page

            if (!hasRender) {
              _context.next = 67;
              break;
            }

            _context.prev = 55;

            debug('rendering 500 page');
            _context.next = 59;
            return this.render('500');

          case 59:
            _context.next = 65;
            break;

          case 61:
            _context.prev = 61;
            _context.t2 = _context['catch'](55);

            debug('could not find 500 page, using built-in 500 html');
            this.body = _500;

          case 65:
            _context.next = 68;
            break;

          case 67:
            this.body = _500;

          case 68:
            _context.next = 76;
            break;

          case 70:

            // flash an error message
            if (hasFlash) this.flash('error', err.message);

            // TODO: until the issue is resolved, we need to add this here
            // <https://github.com/koajs/generic-session/pull/95#issuecomment-246308544>

            if (!(this.sessionStore && this.sessionId && this.session && this.state.cookiesKey)) {
              _context.next = 75;
              break;
            }

            _context.next = 74;
            return _co2.default.wrap(this.sessionStore.set).call(this.sessionStore, this.sessionId, this.session);

          case 74:
            this.cookies.set(this.state.cookiesKey, this.sessionId, this.session.cookie);

          case 75:

            /*
            // if we're using `koa-session-store` we need to add
            // `this._session = new Session()`, and then run this:
            await co.wrap(this._session._store.save).call(
              this._session._store,
              this._session._sid,
              JSON.stringify(this.session)
            );
            this.cookies.set(this._session._name, JSON.stringify({
              _sid: this._session._sid
            }), this._session._cookieOpts);
            */

            // redirect the user to the page they were just on
            this.redirect('back');

          case 76:
            return _context.abrupt('break', 83);

          case 77:
            this.type = 'json';
            this.body = (0, _stringify2.default)(this.body, null, 2);
            return _context.abrupt('break', 83);

          case 80:
            this.type = 'text';
            this.body = (0, _stringify2.default)(this.body, null, 2);
            return _context.abrupt('break', 83);

          case 83:

            this.length = Buffer.byteLength(this.body);
            this.res.end(this.body);

          case 85:
          case 'end':
            return _context.stop();
        }
      }
    }, _callee, this, [[36, 42], [55, 61]]);
  }));

  function errorHandler(_x) {
    return _ref.apply(this, arguments);
  }

  return errorHandler;
}();

function parseValidationError(ctx, err) {

  // inspired by https://github.com/syntagma/mongoose-error-helper
  if (err.name !== 'ValidationError') return err;

  ctx.api = true;

  // loop over the errors object of the Validation Error
  // with support for HTML error lists
  if (_lodash2.default.values(err.errors).length === 1) {
    err.message = _lodash2.default.values(err.errors)[0].message;
  } else {
    var errors = _lodash2.default.map(_lodash2.default.values(err.errors), 'message');
    err.message = ctx.api ? errors.join(', ') : '<ul class="text-xs-left mb-0"><li>' + errors.join('</li><li>') + '</li></ul>';
  }

  return err;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJvcHRzIiwiZW5jb2RpbmciLCJfNDA0IiwicmVhZEZpbGVTeW5jIiwiam9pbiIsIl9fZGlybmFtZSIsIl81MDAiLCJkZWJ1ZyIsImVyciIsImlzRXJyb3IiLCJFcnJvciIsInR5cGUiLCJhY2NlcHRzIiwic3RhdHVzIiwibWVzc2FnZSIsIm5vdEFjY2VwdGFibGUiLCJvdXRwdXQiLCJwYXlsb2FkIiwicGFyc2VWYWxpZGF0aW9uRXJyb3IiLCJ2YWwiLCJwYXJzZUludCIsImlzTnVtYmVyIiwiY3JlYXRlIiwiaXNPYmplY3QiLCJzdGF0dXNDb2RlIiwiaGFzRmxhc2giLCJpc0Z1bmN0aW9uIiwiZmxhc2giLCJoYXNTZXNzaW9ucyIsInNlc3Npb24iLCJzZXNzaW9uU3RvcmUiLCJpc1N0cmluZyIsInNlc3Npb25JZCIsInNldCIsImhhc1JlbmRlciIsInJlbmRlciIsIm5vUmVmZXJyZXIiLCJnZXQiLCJib2R5IiwiYXBwIiwiZW1pdCIsImhlYWRlclNlbnQiLCJ3cml0YWJsZSIsInN0YXRlIiwidGl0bGUiLCJlcnJvciIsImRlc2MiLCJjb29raWVzS2V5Iiwid3JhcCIsImNhbGwiLCJjb29raWVzIiwiY29va2llIiwicmVkaXJlY3QiLCJsZW5ndGgiLCJCdWZmZXIiLCJieXRlTGVuZ3RoIiwicmVzIiwiZW5kIiwiZXJyb3JIYW5kbGVyIiwiY3R4IiwibmFtZSIsImFwaSIsInZhbHVlcyIsImVycm9ycyIsIm1hcCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7QUFFQSxJQUFNQSxPQUFPO0FBQ1hDLFlBQVU7QUFEQyxDQUFiOztBQUlBO0FBQ0E7QUFDQSxJQUFNQyxPQUFPLGFBQUdDLFlBQUgsQ0FBZ0IsZUFBS0MsSUFBTCxDQUFVQyxTQUFWLEVBQXFCLElBQXJCLEVBQTJCLFVBQTNCLENBQWhCLEVBQXdETCxJ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RUQsU0FBT0ksR0FBUDtBQUVEIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgY28gZnJvbSAnY28nO1xuaW1wb3J0IERlYnVnIGZyb20gJ2RlYnVnJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQm9vbSBmcm9tICdib29tJztcbmltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcblxuY29uc3Qgb3B0cyA9IHtcbiAgZW5jb2Rpbmc6ICd1dGY4J1xufTtcblxuLy8gZXJyb3IgcGFnZXMgd2VyZSBpbnNwaXJlZCBieSBIVE1MNSBCb2lsZXJwbGF0ZSdzIGRlZmF1bHQgNDA0Lmh0bWwgcGFnZVxuLy8gaHR0cHM6Ly9naXRodWIuY29tL2g1YnAvaHRtbDUtYm9pbGVycGxhdGUvYmxvYi9tYXN0ZXIvc3JjLzQwNC5odG1sXG5jb25zdCBfNDA0ID0gZnMucmVhZEZpbGVTeW5jKHBhdGguam9pbihfX2Rpcm5hbWUsICcuLicsICc0MDQuaHRtbCcpLCBvcHRzKTtcbmNvbnN0IF81MDAgPSBmcy5yZWFkRmlsZVN5bmMocGF0aC5qb2luKF9fZGlybmFtZSwgJy4uJywgJzUwMC5odG1sJyksIG9wdHMpO1xuXG5jb25zdCBkZWJ1ZyA9IG5ldyBEZWJ1Zygna29hLWJldHRlci1lcnJvci1oYW5kbGVyJyk7XG5cbi8vIGluaXRpYWxpemUgdHJ5L2NhdGNoIGVycm9yIGhhbmRsaW5nIHJpZ2h0IGF3YXlcbi8vIGFkYXB0ZWQgZnJvbTogaHR0cHM6Ly9naXRodWIuY29tL2tvYWpzL29uZXJyb3IvYmxvYi9tYXN0ZXIvaW5kZXguanNcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9rb2Fqcy9leGFtcGxlcy9pc3N1ZXMvMjAjaXNzdWVjb21tZW50LTMxNTY4NDAxXG4vL1xuLy8gaW5zcGlyZWQgYnk6XG4vLyBodHRwczovL2dvby5nbC82Mm9VN1Bcbi8vIGh0dHBzOi8vZ29vLmdsLzhaN2FNZVxuXG5leHBvcnQgZGVmYXVsdCBhc3luYyBmdW5jdGlvbiBlcnJvckhhbmRsZXIoZXJyKSB7XG5cbiAgaWYgKCFlcnIpIHJldHVybjtcblxuICBpZiAoIV8uaXNFcnJvcihlcnIpKVxuICAgIGVyciA9IG5ldyBFcnJvcihlcnIpO1xuXG4gIGNvbnN0IHR5cGUgPSB0aGlzLmFjY2VwdHMoWyd0ZXh0JywgJ2pzb24nLCAnaHRtbCddKTtcblxuICBpZiAoIXR5cGUpIHtcbiAgICBkZWJ1ZygnaW52YWxpZCB0eXBlLCBzZW5kaW5nIDQwNiBlcnJvcicpO1xuICAgIGVyci5zdGF0dXMgPSA0MDY7XG4gICAgZXJyLm1lc3NhZ2UgPSBCb29tLm5vdEFjY2VwdGFibGUoKS5vdXRwdXQucGF5bG9hZDtcbiAgfVxuXG4gIC8vIHBhcnNlIG1vbmdvb3NlIHZhbGlkYXRpb24gZXJyb3JzXG4gIGVyciA9IHBhcnNlVmFsaWRhdGlvbkVycm9yKHRoaXMsIGVycik7XG5cbiAgLy8gY2hlY2sgaWYgd2UgdGhyZXcganVzdCBhIHN0YXR1cyBjb2RlIGluIG9yZGVyIHRvIGtlZXAgaXQgc2ltcGxlXG4gIGNvbnN0IHZhbCA9IHBhcnNlSW50KGVyci5tZXNzYWdlLCAxMCk7XG4gIGlmIChfLmlzTnVtYmVyKHZhbCkgJiYgdmFsID49IDQwMClcbiAgICBlcnIgPSBCb29tLmNyZWF0ZSh2YWwpO1xuXG4gIC8vIGNoZWNrIGlmIHdlIGhhdmUgYSBib29tIGVycm9yIHRoYXQgc3BlY2lmaWVkXG4gIC8vIGEgc3RhdHVzIGNvZGUgYWxyZWFkeSBmb3IgdXMgKGFuZCB0aGVuIHVzZSBpdClcbiAgaWYgKF8uaXNPYmplY3QoZXJyLm91dHB1dCkgJiYgXy5pc051bWJlcihlcnIub3V0cHV0LnN0YXR1c0NvZGUpKVxuICAgIGVyci5zdGF0dXMgPSBlcnIub3V0cHV0LnN0YXR1c0NvZGU7XG5cbiAgaWYgKCFfLmlzTnVtYmVyKGVyci5zdGF0dXMpKVxuICAgIGVyci5zdGF0dXMgPSA1MDA7XG5cbiAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgZmxhc2ggbWVzc2FnaW5nXG4gIGNvbnN0IGhhc0ZsYXNoID0gXy5pc0Z1bmN0aW9uKHRoaXMuZmxhc2gpO1xuICBkZWJ1ZygnaGFzRmxhc2gnLCBoYXNGbGFzaCk7XG5cbiAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgc2Vzc2lvbiBzdXBwb3J0XG4gIGNvbnN0IGhhc1Nlc3Npb25zID0gXy5pc09iamVjdCh0aGlzLnNlc3Npb24pXG4gICAgJiYgXy5pc09iamVjdCh0aGlzLnNlc3Npb25TdG9yZSlcbiAgICAmJiBfLmlzU3RyaW5nKHRoaXMuc2Vzc2lvbklkKVxuICAgICYmIF8uaXNPYmplY3QodGhpcy5zZXNzaW9uKVxuICAgICYmIF8uaXNGdW5jdGlvbih0aGlzLnNlc3Npb25TdG9yZS5zZXQpO1xuICBkZWJ1ZygnaGFzU2Vzc2lvbnMnLCBoYXNTZXNzaW9ucyk7XG5cbiAgLy8gY2hlY2sgaWYgdGhlcmUgaXMgYSB2aWV3IHJlbmRlcmluZyBlbmdpbmUgYmluZGluZyBgdGhpcy5yZW5kZXJgXG4gIGNvbnN0IGhhc1JlbmRlciA9IF8uaXNGdW5jdGlvbih0aGlzLnJlbmRlcik7XG4gIGRlYnVnKCdoYXNSZW5kZXInLCBoYXNSZW5kZXIpO1xuXG4gIC8vIGNoZWNrIGlmIHdlJ3JlIGFib3V0IHRvIGdvIGludG8gYSBwb3NzaWJsZSBlbmRsZXNzIHJlZGlyZWN0IGxvb3BcbiAgY29uc3Qgbm9SZWZlcnJlciA9IHRoaXMuZ2V0KCdSZWZlcnJlcicpID09PSAnJztcblxuICAvLyBwb3B1bGF0ZSB0aGUgc3RhdHVzIGFuZCBib2R5IHdpdGggYGJvb21gIGVycm9yIG1lc3NhZ2UgcGF5bG9hZFxuICAvLyAoZS5nLiB5b3UgY2FuIGRvIGBjdHgudGhyb3coNDA0KWAgYW5kIGl0IHdpbGwgb3V0cHV0IGEgYmVhdXRpZnVsIGVyciBvYmopXG4gIHRoaXMuc3RhdHVzID0gdGhpcy5zdGF0dXNDb2RlID0gZXJyLnN0YXR1c0NvZGUgPSBlcnIuc3RhdHVzID0gZXJyLnN0YXR1cyB8fCA1MDA7XG4gIHRoaXMuYm9keSA9IEJvb20uY3JlYXRlKGVyci5zdGF0dXMsIGVyci5tZXNzYWdlKS5vdXRwdXQucGF5bG9hZDtcblxuICBkZWJ1Zygnc3RhdHVzIGNvZGUgd2FzICVkJywgdGhpcy5zdGF0dXMpO1xuXG4gIHRoaXMuYXBwLmVtaXQoJ2Vycm9yJywgZXJyLCB0aGlzKTtcblxuICAvLyBub3RoaW5nIHdlIGNhbiBkbyBoZXJlIG90aGVyXG4gIC8vIHRoYW4gZGVsZWdhdGUgdG8gdGhlIGFwcC1sZXZlbFxuICAvLyBoYW5kbGVyIGFuZCBsb2cuXG4gIGlmICh0aGlzLmhlYWRlclNlbnQgfHwgIXRoaXMud3JpdGFibGUpIHtcbiAgICBkZWJ1ZygnaGVhZGVycyB3ZXJlIGFscmVhZHkgc2VudCwgcmV0dXJuaW5nIGVhcmx5Jyk7XG4gICAgZXJyLmhlYWRlclNlbnQgPSB0cnVlO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIC8vIGZpeCBwYWdlIHRpdGxlIGFuZCBkZXNjcmlwdGlvblxuICB0aGlzLnN0YXRlLnRpdGxlID0gdGhpcy5ib2R5LmVycm9yO1xuICBkZWJ1Zygnc2V0IGB0aGlzLnN0YXRlLnRpdGxlYCB0byAlcycsIHRoaXMuc3RhdGUudGl0bGUpO1xuICB0aGlzLnN0YXRlLmRlc2MgPSBlcnIubWVzc2FnZTtcbiAgZGVidWcoJ3NldCBgdGhpcy5zdGF0ZS5kZXNjYCB0byAlcycsIHRoaXMuc3RhdGUuZGVzYyk7XG5cbiAgZGVidWcoJ3R5cGUgd2FzICVzJywgdHlwZSk7XG5cbiAgc3dpdGNoICh0eXBlKSB7XG4gICAgY2FzZSAnaHRtbCc6XG5cbiAgICAgIHRoaXMudHlwZSA9ICdodG1sJztcblxuICAgICAgaWYgKHRoaXMuc3RhdHVzID09PSA0MDQpIHtcblxuICAgICAgICAvLyByZW5kZXIgdGhlIDQwNCBwYWdlXG4gICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9rb2Fqcy9rb2EvaXNzdWVzLzY0NlxuICAgICAgICBpZiAoaGFzUmVuZGVyKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRlYnVnKCdyZW5kZXJpbmcgNDA0IHBhZ2UnKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucmVuZGVyKCc0MDQnKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGRlYnVnKCdjb3VsZCBub3QgZmluZCA0MDQgcGFnZSwgdXNpbmcgYnVpbHQtaW4gNDA0IGh0bWwnKTtcbiAgICAgICAgICAgIHRoaXMuYm9keSA9IF80MDQ7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuYm9keSA9IF80MDQ7XG4gICAgICAgIH1cblxuICAgICAgfSBlbHNlIGlmIChub1JlZmVycmVyIHx8IHRoaXMuc3RhdHVzID09PSA1MDApIHtcblxuICAgICAgICAvLyB0aGlzIHByZXZlbnRzIGEgcmVkaXJlY3QgbG9vcCBieSBkZXRlY3RpbmcgYW4gZW1wdHkgUmVmZXJyZXJcbiAgICAgICAgLy8gLi4ub3RoZXJ3aXNlIGl0IHdvdWxkIHJlYWNoIHRoZSBuZXh0IGNvbmRpdGlvbmFsIGJsb2NrIHdoaWNoXG4gICAgICAgIC8vIHdvdWxkIGVuZGxlc3NseSByZWRpcmV0IHRoZSB1c2VyIHdpdGggYHRoaXMucmVkaXJlY3QoJ2JhY2snKWBcbiAgICAgICAgaWYgKG5vUmVmZXJyZXIpXG4gICAgICAgICAgZGVidWcoJ3ByZXZlbnRlZCBlbmRsZXNzIHJlZGlyZWN0IGxvb3AhJyk7XG5cbiAgICAgICAgLy8gZmxhc2ggYW4gZXJyb3IgbWVzc2FnZVxuICAgICAgICBpZiAoaGFzRmxhc2gpXG4gICAgICAgICAgdGhpcy5mbGFzaCgnZXJyb3InLCBlcnIubWVzc2FnZSk7XG5cbiAgICAgICAgLy8gcmVuZGVyIHRoZSA1MDAgcGFnZVxuICAgICAgICBpZiAoaGFzUmVuZGVyKSB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGRlYnVnKCdyZW5kZXJpbmcgNTAwIHBhZ2UnKTtcbiAgICAgICAgICAgIGF3YWl0IHRoaXMucmVuZGVyKCc1MDAnKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICAgIGRlYnVnKCdjb3VsZCBub3QgZmluZCA1MDAgcGFnZSwgdXNpbmcgYnVpbHQtaW4gNTAwIGh0bWwnKTtcbiAgICAgICAgICAgIHRoaXMuYm9keSA9IF81MDA7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMuYm9keSA9IF81MDA7XG4gICAgICAgIH1cblxuICAgICAgfSBlbHNlIHtcblxuICAgICAgICAvLyBmbGFzaCBhbiBlcnJvciBtZXNzYWdlXG4gICAgICAgIGlmIChoYXNGbGFzaClcbiAgICAgICAgICB0aGlzLmZsYXNoKCdlcnJvcicsIGVyci5tZXNzYWdlKTtcblxuICAgICAgICAvLyBUT0RPOiB1bnRpbCB0aGUgaXNzdWUgaXMgcmVzb2x2ZWQsIHdlIG5lZWQgdG8gYWRkIHRoaXMgaGVyZVxuICAgICAgICAvLyA8aHR0cHM6Ly9naXRodWIuY29tL2tvYWpzL2dlbmVyaWMtc2Vzc2lvbi9wdWxsLzk1I2lzc3VlY29tbWVudC0yNDYzMDg1NDQ+XG4gICAgICAgIGlmICh0aGlzLnNlc3Npb25TdG9yZSAmJiB0aGlzLnNlc3Npb25JZCAmJiB0aGlzLnNlc3Npb24gJiYgdGhpcy5zdGF0ZS5jb29raWVzS2V5KSB7XG4gICAgICAgICAgYXdhaXQgY28ud3JhcCh0aGlzLnNlc3Npb25TdG9yZS5zZXQpLmNhbGwoXG4gICAgICAgICAgICB0aGlzLnNlc3Npb25TdG9yZSxcbiAgICAgICAgICAgIHRoaXMuc2Vzc2lvbklkLFxuICAgICAgICAgICAgdGhpcy5zZXNzaW9uXG4gICAgICAgICAgKTtcbiAgICAgICAgICB0aGlzLmNvb2tpZXMuc2V0KFxuICAgICAgICAgICAgdGhpcy5zdGF0ZS5jb29raWVzS2V5LFxuICAgICAgICAgICAgdGhpcy5zZXNzaW9uSWQsXG4gICAgICAgICAgICB0aGlzLnNlc3Npb24uY29va2llXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8qXG4gICAgICAgIC8vIGlmIHdlJ3JlIHVzaW5nIGBrb2Etc2Vzc2lvbi1zdG9yZWAgd2UgbmVlZCB0byBhZGRcbiAgICAgICAgLy8gYHRoaXMuX3Nlc3Npb24gPSBuZXcgU2Vzc2lvbigpYCwgYW5kIHRoZW4gcnVuIHRoaXM6XG4gICAgICAgIGF3YWl0IGNvLndyYXAodGhpcy5fc2Vzc2lvbi5fc3RvcmUuc2F2ZSkuY2FsbChcbiAgICAgICAgICB0aGlzLl9zZXNzaW9uLl9zdG9yZSxcbiAgICAgICAgICB0aGlzLl9zZXNzaW9uLl9zaWQsXG4gICAgICAgICAgSlNPTi5zdHJpbmdpZnkodGhpcy5zZXNzaW9uKVxuICAgICAgICApO1xuICAgICAgICB0aGlzLmNvb2tpZXMuc2V0KHRoaXMuX3Nlc3Npb24uX25hbWUsIEpTT04uc3RyaW5naWZ5KHtcbiAgICAgICAgICBfc2lkOiB0aGlzLl9zZXNzaW9uLl9zaWRcbiAgICAgICAgfSksIHRoaXMuX3Nlc3Npb24uX2Nvb2tpZU9wdHMpO1xuICAgICAgICAqL1xuXG4gICAgICAgIC8vIHJlZGlyZWN0IHRoZSB1c2VyIHRvIHRoZSBwYWdlIHRoZXkgd2VyZSBqdXN0IG9uXG4gICAgICAgIHRoaXMucmVkaXJlY3QoJ2JhY2snKTtcblxuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSAnanNvbic6XG4gICAgICB0aGlzLnR5cGUgPSAnanNvbic7XG4gICAgICB0aGlzLmJvZHkgPSBKU09OLnN0cmluZ2lmeSh0aGlzLmJvZHksIG51bGwsIDIpO1xuICAgICAgYnJlYWs7XG4gICAgZGVmYXVsdDpcbiAgICAgIHRoaXMudHlwZSA9ICd0ZXh0JztcbiAgICAgIHRoaXMuYm9keSA9IEpTT04uc3RyaW5naWZ5KHRoaXMuYm9keSwgbnVsbCwgMik7XG4gICAgICBicmVhaztcbiAgfVxuXG4gIHRoaXMubGVuZ3RoID0gQnVmZmVyLmJ5dGVMZW5ndGgodGhpcy5ib2R5KTtcbiAgdGhpcy5yZXMuZW5kKHRoaXMuYm9keSk7XG5cbn07XG5cbmZ1bmN0aW9uIHBhcnNlVmFsaWRhdGlvbkVycm9yKGN0eCwgZXJyKSB7XG5cbiAgLy8gaW5zcGlyZWQgYnkgaHR0cHM6Ly9naXRodWIuY29tL3N5bnRhZ21hL21vbmdvb3NlLWVycm9yLWhlbHBlclxuICBpZiAoZXJyLm5hbWUgIT09ICdWYWxpZGF0aW9uRXJyb3InKVxuICAgIHJldHVybiBlcnI7XG5cbiAgY3R4LmFwaSA9IHRydWU7XG5cbiAgLy8gbG9vcCBvdmVyIHRoZSBlcnJvcnMgb2JqZWN0IG9mIHRoZSBWYWxpZGF0aW9uIEVycm9yXG4gIC8vIHdpdGggc3VwcG9ydCBmb3IgSFRNTCBlcnJvciBsaXN0c1xuICBpZiAoXy52YWx1ZXMoZXJyLmVycm9ycykubGVuZ3RoID09PSAxKSB7XG4gICAgZXJyLm1lc3NhZ2UgPSBfLnZhbHVlcyhlcnIuZXJyb3JzKVswXS5tZXNzYWdlO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IGVycm9ycyA9IF8ubWFwKF8udmFsdWVzKGVyci5lcnJvcnMpLCAnbWVzc2FnZScpO1xuICAgIGVyci5tZXNzYWdlID0gY3R4LmFwaSA/XG4gICAgICBlcnJvcnMuam9pbignLCAnKVxuICAgICAgOiBgPHVsIGNsYXNzPVwidGV4dC14cy1sZWZ0IG1iLTBcIj48bGk+JHtlcnJvcnMuam9pbignPC9saT48bGk+Jyl9PC9saT48L3VsPmA7XG4gIH1cblxuICByZXR1cm4gZXJyO1xuXG59XG4iXX0=